<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!--
        Sub-template: Consumos por Contactos Empresa
        Variable de contexto: wizard (internal.consumption.report.wizard)
    -->
    <template id="report_consumption_by_partner">
        <t t-set="partners_data" t-value="wizard._get_consumptions_by_partner()"/>

        <!-- Sin datos -->
        <t t-if="not partners_data">
            <p class="text-muted fst-italic text-center py-4">
                No se encontraron consumos emitidos para los criterios seleccionados.
            </p>
        </t>

        <!-- Iterar empresas/contactos -->
        <t t-foreach="partners_data" t-as="partner_data">

            <!-- Título de sección -->
            <h5 class="border-bottom pb-1 mt-3">
                <span t-esc="partner_data['partner'].name"/>
            </h5>

            <!-- Ficha de configuración -->
            <p class="small text-muted mb-2">
                <strong>Configuración:</strong> <span t-esc="partner_data['config'].name"/> —
                <strong>Empresa:</strong> <span t-esc="partner_data['partner'].name"/> —
                <strong>Total:</strong>
                <span t-esc="partner_data['total_consumptions']"/> consumos /
                <strong><span t-esc="'{:,.2f}'.format(partner_data['total_amount'])"/> <span t-esc="partner_data['config'].currency_id.symbol"/></strong>
            </p>

            <!-- Tabla detallada (sin agrupación) -->
            <t t-if="not wizard.group_by_children">
                <table class="table table-sm table-borderless">
                    <thead class="o_black_border">
                        <tr>
                            <th>Fecha</th>
                            <th>Referencia</th>
                            <th>Contacto</th>
                            <th class="text-end">Monto</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="partner_data['consumptions']" t-as="c">
                            <tr>
                                <td><span t-out="c.consumption_date"/></td>
                                <td><span t-esc="c.name"/></td>
                                <td><span t-esc="c.partner_id.name or 'N/A'"/></td>
                                <td class="text-end">
                                    <span t-esc="'{:,.2f}'.format(c.amount_total)"/>
                                    <span t-esc="c.currency_id.symbol"/>
                                </td>
                            </tr>
                        </t>
                        <tr class="o_total o_border_bottom fw-bold">
                            <td colspan="3">Total</td>
                            <td class="text-end">
                                <span t-esc="'{:,.2f}'.format(partner_data['total_amount'])"/>
                                <span t-esc="partner_data['config'].currency_id.symbol"/>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </t>

            <!-- Tabla agrupada por contacto hijo -->
            <t t-if="wizard.group_by_children and partner_data.get('children')">
                <table class="table table-sm table-borderless">
                    <thead class="o_black_border">
                        <tr>
                            <th>Contacto</th>
                            <th>Primer Consumo</th>
                            <th>Último Consumo</th>
                            <th class="text-center">N° Consumos</th>
                            <th class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="partner_data['children']" t-as="child">
                            <tr>
                                <td><span t-esc="child['partner'].name"/></td>
                                <td><span t-out="child['date_first']"/></td>
                                <td><span t-out="child['date_last']"/></td>
                                <td class="text-center"><span t-esc="child['total_count']"/></td>
                                <td class="text-end">
                                    <span t-esc="'{:,.2f}'.format(child['total_amount'])"/>
                                    <span t-esc="partner_data['config'].currency_id.symbol"/>
                                </td>
                            </tr>
                        </t>
                        <tr class="o_total o_border_bottom fw-bold">
                            <td colspan="4">Total</td>
                            <td class="text-end">
                                <span t-esc="'{:,.2f}'.format(partner_data['total_amount'])"/>
                                <span t-esc="partner_data['config'].currency_id.symbol"/>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </t>

            <!-- Salto de página entre empresas (excepto la última) -->
            <t t-if="not partner_data_last">
                <p style="page-break-after:always;"/>
            </t>
        </t>

        <!-- Resumen General (solo si hay más de 1 empresa) -->
        <t t-if="partners_data and len(partners_data) > 1">
            <t t-set="grand_total" t-value="sum([p['total_amount'] for p in partners_data])"/>
            <t t-set="grand_count" t-value="sum([p['total_consumptions'] for p in partners_data])"/>
            <t t-set="sym"         t-value="partners_data[0]['config'].currency_id.symbol"/>

            <h5 class="border-bottom pb-1 mt-4">Resumen General</h5>
            <table class="table table-sm table-borderless">
                <thead class="o_black_border">
                    <tr>
                        <th>Empresa / Contacto</th>
                        <th class="text-center">N° Consumos</th>
                        <th class="text-end">Total</th>
                    </tr>
                </thead>
                <tbody>
                    <t t-foreach="partners_data" t-as="p">
                        <tr>
                            <td><span t-esc="p['partner'].name"/></td>
                            <td class="text-center"><span t-esc="p['total_consumptions']"/></td>
                            <td class="text-end">
                                <span t-esc="'{:,.2f}'.format(p['total_amount'])"/>
                                <span t-esc="sym"/>
                            </td>
                        </tr>
                    </t>
                    <tr class="o_total o_border_bottom fw-bold">
                        <td>Total General (<span t-esc="len(partners_data)"/> empresas)</td>
                        <td class="text-center"><span t-esc="grand_count"/></td>
                        <td class="text-end"><span t-esc="'{:,.2f}'.format(grand_total)"/> <span t-esc="sym"/></td>
                    </tr>
                </tbody>
            </table>
        </t>
    </template>

</odoo>
